{
    "variables": {
        "iso_url": "file:///home/mathieu/Téléchargements/guix-system-install-1.1.0.x86_64-linux.iso",
        "iso_checksum": "0184a2d68b8635d39017289de9a3d58f5fc4ed7eae6eba8c7344149b0fddd58c",
        "iso_checksum_type": "sha256",
        "image_name": "guix"
    },
    "builders": [
        {
            "type": "qemu",
            "vm_name": "{{user `image_name`}}.qcow2",
            "iso_url": "{{user `iso_url`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `image_checksum_type`}}",
            "disk_image": false,
            "disk_size": 6000,
            "disk_compression": true,
            "disk_interface": "virtio",
            "format": "qcow2",
            "net_device": "virtio-net",
            "communicator": "ssh",
            "ssh_username": "guix",
            "ssh_password": "azijiauzjiirhziahrznniYTT",
            "ssh_handshake_attempts": 300,
            "ssh_timeout": "300m",
            "ssh_port": 22,
            "vnc_port_min": 5910,
            "vnc_port_max": 5910,
            "http_directory": "{{user `image_name`}}/http",
            "use_default_display": true,
            "qemuargs": [
                ["-drive", "file=output-qemu/{{user `image_name`}}.qcow2,if=virtio,cache=writeback,discard=ignore,format=qcow2"],
                [ "-m", "1000M" ],
                ["-smp", "2"]
            ],
            "boot_key_interval": "200ms",
            "boot_command": [
                "<wait15>",
                "<enter>",
                "<down><down><down><down><down><down><down><down><down><down><down><down><down><down><down>",
                "<enter>",
                "<down>",
                "<enter>",
                "<wait2>",
                "<enter>",
                "cfdisk",
                "<enter>",
                "<enter>",
                "<enter>",
                "<del>",
                "<del>",
                "<del>",
                "<del>",
                "4M",
                "<enter>",
                "<right>",
                "<enter>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<up>",
                "<enter>",
                "<down>",
                "<enter>",
                "<enter>",
                "<right>",
                "<enter>",
                "<down>",
                "<down>",
                "<down>",
                "<down>",
                "<enter>",
                "<right>",
                "<right>",
                "<enter>",
                "yes",
                "<enter>",
                "<left>",
                "<left>",
                "<left>",
                "<enter>",
                "mkfs.ext4 -L my-root /dev/vda2",
                "<enter>",
                "<wait2>",
                "mount LABEL=my-root /mnt",
                "<enter>",
                "herd start cow-store /mnt",
                "<enter>",
                "mkdir /mnt/etc",
                "<enter>",
                "mkdir /mnt/temporal",
                "<enter>",
                "guile -c '(use-modules (web client)) (define-values (a b) (http-request \"http://{{ .HTTPIP }}:{{ .HTTPPort }}/config.scm\")) (display b)' > /mnt/etc/config.scm",
                "<enter>",
                "<wait5>",
                "cat /mnt/etc/config.scm",
                "<enter>",
                "TMPDIR=/mnt/temporal guix system init /mnt/etc/config.scm /mnt && sleep 5 && reboot",
                "<enter>"
            ]
        }
    ],
    "provisioners": [
        {"type": "file",
         "source": "{{user `image_name`}}/bash_profile",
         "destination": "/home/guix/.bash_profile"
        },
        {"type": "shell",
         "scripts": [
             "{{user `image_name`}}/script.sh"
         ]
        }
    ],
    "post-processors": [
        {
            "type": "shell-local",
            "inline": ["qemu-img resize output-qemu/guix.qcow2 10G"]
        }
    ]
}

